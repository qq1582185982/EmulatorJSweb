<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EmulatorJS æ¸¸æˆä¸­å¿ƒ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Microsoft YaHei', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        header {
            text-align: center;
            color: white;
            margin-bottom: 40px;
        }

        h1 {
            font-size: 3em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .subtitle {
            font-size: 1.2em;
            opacity: 0.9;
        }

        .filter-bar {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 30px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .filter-bar .left {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .filter-bar select {
            padding: 10px 15px;
            border: 2px solid #667eea;
            border-radius: 5px;
            font-size: 16px;
            cursor: pointer;
        }

        #search-input {
            padding: 10px 15px;
            border: 2px solid #667eea;
            border-radius: 5px;
            font-size: 16px;
            width: 250px;
            transition: all 0.3s;
        }

        #search-input:focus {
            outline: none;
            border-color: #5568d3;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        #search-input::placeholder {
            color: #999;
        }

        #logout-btn {
            padding: 10px 20px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s;
            white-space: nowrap;
            flex-shrink: 0;
        }

        #logout-btn:hover {
            background: #5568d3;
        }

        .games-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 25px;
        }

        .game-card {
            background: white;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 10px 20px rgba(0,0,0,0.1);
            transition: transform 0.3s, box-shadow 0.3s;
            cursor: pointer;
        }

        .game-card:hover {
            transform: translateY(-10px);
            box-shadow: 0 15px 30px rgba(0,0,0,0.2);
        }

        .game-image {
            width: 100%;
            height: 180px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 3em;
        }

        .game-info {
            padding: 20px;
        }

        .game-title {
            font-size: 1.2em;
            font-weight: bold;
            color: #333;
            margin-bottom: 10px;
            word-wrap: break-word;
            overflow-wrap: break-word;
            word-break: break-word;
            line-height: 1.4;
        }

        .game-system {
            display: inline-block;
            background: #667eea;
            color: white;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.85em;
            margin-bottom: 10px;
        }

        .game-desc {
            color: #666;
            font-size: 0.9em;
            line-height: 1.4;
        }

        .no-games {
            text-align: center;
            color: white;
            font-size: 1.5em;
            margin-top: 50px;
        }

        /* HACKè¯´æ˜æŒ‰é’® */
        #hack-info-btn {
            padding: 10px 20px;
            background: #28a745;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s;
            white-space: nowrap;
            margin-left: 10px;
        }

        #hack-info-btn:hover {
            background: #218838;
        }

        /* HACKè¯´æ˜å¼¹çª— */
        .hack-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 10000;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .hack-modal.show {
            display: flex;
        }

        .hack-modal-content {
            background: white;
            border-radius: 15px;
            max-width: 800px;
            max-height: 80vh;
            width: 100%;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }

        .hack-modal-header {
            padding: 20px 25px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .hack-modal-title {
            font-size: 1.5em;
            font-weight: bold;
            margin: 0;
        }

        .hack-modal-close {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            font-size: 2em;
            cursor: pointer;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
        }

        .hack-modal-close:hover {
            background: rgba(255,255,255,0.3);
            transform: rotate(90deg);
        }

        .hack-modal-body {
            padding: 25px;
            overflow-y: auto;
            flex: 1;
        }

        .hack-modal-body h3 {
            color: #667eea;
            margin-top: 20px;
            margin-bottom: 10px;
            padding-bottom: 5px;
            border-bottom: 2px solid #667eea;
        }

        .hack-modal-body p {
            line-height: 1.6;
            color: #555;
            margin: 10px 0;
        }

        .hack-modal-body ul {
            margin: 10px 0;
            padding-left: 25px;
        }

        .hack-modal-body li {
            margin: 8px 0;
            line-height: 1.5;
        }

        .hack-modal-body pre {
            background: #f5f5f5;
            padding: 15px;
            border-radius: 5px;
            overflow-x: auto;
            border-left: 4px solid #667eea;
        }

        .no-hack-info {
            text-align: center;
            color: #999;
            padding: 40px;
            font-size: 1.1em;
        }

        /* ç§»åŠ¨ç«¯é€‚é… */
        @media (max-width: 768px) {
            body {
                padding: 10px;
            }

            h1 {
                font-size: 2em;
                margin-bottom: 8px;
            }

            .subtitle {
                font-size: 1em;
            }

            header {
                margin-bottom: 25px;
            }

            .filter-bar {
                padding: 15px;
                margin-bottom: 20px;
                flex-direction: column !important;
                align-items: stretch !important;
                gap: 15px;
            }

            .filter-bar .left {
                flex-direction: column;
                align-items: stretch;
                margin-bottom: 0;
                gap: 8px;
            }

            .filter-bar label {
                margin-bottom: 0;
            }

            .filter-bar select {
                padding: 10px 12px;
                font-size: 14px;
                width: 100%;
            }

            #search-input {
                width: 100%;
                padding: 10px 12px;
                font-size: 14px;
            }

            #logout-btn, #hack-info-btn {
                padding: 10px 16px;
                font-size: 14px;
                width: 100%;
                margin-top: 0;
                margin-left: 0;
            }

            #hack-info-btn {
                margin-top: 10px;
            }

            .hack-modal-content {
                max-width: 95vw;
                max-height: 90vh;
            }

            .hack-modal-header {
                padding: 15px 20px;
            }

            .hack-modal-title {
                font-size: 1.2em;
            }

            .hack-modal-body {
                padding: 20px;
            }

            .games-grid {
                grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
                gap: 15px;
            }

            .game-image {
                height: 140px;
                font-size: 2em;
            }

            .game-info {
                padding: 15px;
            }

            .game-title {
                font-size: 1em;
            }

            .game-desc {
                font-size: 0.85em;
            }
        }

        /* å°å±æ‰‹æœºé€‚é… */
        @media (max-width: 480px) {
            h1 {
                font-size: 1.8em;
            }

            .subtitle {
                font-size: 0.9em;
            }

            .games-grid {
                grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
                gap: 12px;
            }

            .game-image {
                height: 120px;
                font-size: 1.8em;
            }

            .game-info {
                padding: 12px;
            }

            .game-title {
                font-size: 0.95em;
            }

            .game-system {
                font-size: 0.8em;
                padding: 4px 10px;
            }

            .game-desc {
                font-size: 0.8em;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>ğŸ® EmulatorJS æ¸¸æˆä¸­å¿ƒ</h1>
            <p class="subtitle">åœ¨çº¿æ¸¸ç©ç»å…¸æ¸¸æˆï¼Œå­˜æ¡£è‡ªåŠ¨äº‘ç«¯ä¿å­˜</p>
        </header>

        <div class="filter-bar">
            <div class="left">
                <input type="text" id="search-input" placeholder="ğŸ” æœç´¢æ¸¸æˆåç§°..." oninput="filterGames()">
                <label>ç­›é€‰æ¸¸æˆæœºï¼š</label>
                <select id="systemFilter" onchange="filterGames()">
                    <option value="all">å…¨éƒ¨æ¸¸æˆæœº</option>
                    <optgroup label="ğŸ® ä»»å¤©å ‚ Nintendo">
                        <option value="nes">ä»»å¤©å ‚ NES</option>
                        <option value="snes">è¶…çº§ä»»å¤©å ‚ SNES</option>
                        <option value="n64">ä»»å¤©å ‚ 64</option>
                        <option value="nds">ä»»å¤©å ‚ DS</option>
                        <option value="gba">Game Boy Advance</option>
                        <option value="gb">Game Boy</option>
                        <option value="vb">Virtual Boy</option>
                    </optgroup>
                    <optgroup label="ğŸ® ä¸–å˜‰ Sega">
                        <option value="segaMD">ä¸–å˜‰ MD / Genesis</option>
                        <option value="segaMS">ä¸–å˜‰ Master System</option>
                        <option value="segaGG">ä¸–å˜‰ Game Gear</option>
                        <option value="segaCD">ä¸–å˜‰ CD</option>
                        <option value="sega32x">ä¸–å˜‰ 32X</option>
                        <option value="segaSaturn">ä¸–å˜‰ Saturn</option>
                    </optgroup>
                    <optgroup label="ğŸ® ç´¢å°¼ Sony">
                        <option value="psx">PlayStation</option>
                        <option value="psp">PlayStation Portable</option>
                    </optgroup>
                    <optgroup label="ğŸ® é›…è¾¾åˆ© Atari">
                        <option value="atari2600">Atari 2600</option>
                        <option value="atari5200">Atari 5200</option>
                        <option value="atari7800">Atari 7800</option>
                        <option value="lynx">Atari Lynx</option>
                        <option value="jaguar">Atari Jaguar</option>
                    </optgroup>
                    <optgroup label="ğŸ’» Commodore">
                        <option value="c64">Commodore 64</option>
                        <option value="c128">Commodore 128</option>
                        <option value="amiga">Commodore Amiga</option>
                        <option value="vic20">Commodore VIC-20</option>
                    </optgroup>
                    <optgroup label="ğŸ•¹ï¸ å…¶ä»– Other">
                        <option value="arcade">è¡—æœº Arcade</option>
                        <option value="mame2003">MAME 2003</option>
                        <option value="3do">3DO</option>
                        <option value="coleco">ColecoVision</option>
                    </optgroup>
                </select>
            </div>
            <div style="display: flex; gap: 10px;">
                <button id="hack-info-btn" onclick="showHackInfo()">ğŸ“ HACKè¯´æ˜</button>
                <button id="logout-btn" onclick="logout()">é€€å‡ºç™»å½•</button>
            </div>
        </div>

        <!-- HACKè¯´æ˜å¼¹çª— -->
        <div class="hack-modal" id="hackModal" onclick="closeHackModal(event)">
            <div class="hack-modal-content" onclick="event.stopPropagation()">
                <div class="hack-modal-header">
                    <h2 class="hack-modal-title" id="hackModalTitle">æ¸¸æˆHACKè¯´æ˜</h2>
                    <button class="hack-modal-close" onclick="closeHackModal()">Ã—</button>
                </div>
                <div class="hack-modal-body" id="hackModalBody">
                    <div class="no-hack-info">æ­£åœ¨åŠ è½½...</div>
                </div>
            </div>
        </div>

        <div class="games-grid" id="gamesGrid">
            <!-- æ¸¸æˆå¡ç‰‡å°†ç”±JavaScriptåŠ¨æ€ç”Ÿæˆ -->
        </div>

        <div class="no-games" id="noGames" style="display:none;">
            æš‚æ— æ¸¸æˆï¼Œè¯·å…ˆä¸Šä¼ ROMæ–‡ä»¶åˆ°æœåŠ¡å™¨
        </div>
    </div>

    <script>
        // æ¸¸æˆæ•°æ®é…ç½®
        const gamesConfig = {
            nes: {
                name: 'ä»»å¤©å ‚ NES',
                color: '#E60012',
                icon: 'ğŸ®',
                games: []
            },
            snes: {
                name: 'è¶…çº§ä»»å¤©å ‚',
                color: '#8F8F8F',
                icon: 'ğŸ¯',
                games: []
            },
            gba: {
                name: 'GBA',
                color: '#5E2CA5',
                icon: 'ğŸ°',
                games: []
            },
            gb: {
                name: 'Game Boy',
                color: '#9BBC0F',
                icon: 'ğŸ“±',
                games: []
            },
            n64: {
                name: 'ä»»å¤©å ‚64',
                color: '#0066CC',
                icon: 'ğŸ²',
                games: []
            },
            psx: {
                name: 'PlayStation',
                color: '#003791',
                icon: 'ğŸª',
                games: []
            }
        };

        // æ™ºèƒ½æ–‡æœ¬è§£ç å‡½æ•° - è‡ªåŠ¨æ£€æµ‹ç¼–ç 
        function autoDecodeText(uint8Array) {
            // 1. æ£€æŸ¥ UTF-8 BOM (EF BB BF)
            if (uint8Array.length >= 3 &&
                uint8Array[0] === 0xEF &&
                uint8Array[1] === 0xBB &&
                uint8Array[2] === 0xBF) {
                // UTF-8 with BOM
                const decoder = new TextDecoder('utf-8');
                return decoder.decode(uint8Array.slice(3));
            }

            // 2. å°è¯• UTF-8 è§£ç ï¼ˆä¸¥æ ¼æ¨¡å¼ï¼‰
            try {
                const decoder = new TextDecoder('utf-8', { fatal: true });
                const text = decoder.decode(uint8Array);
                // éªŒè¯è§£ç æˆåŠŸä¸”æ²¡æœ‰æ›¿æ¢å­—ç¬¦
                if (text && !text.includes('ï¿½')) {
                    return text;
                }
            } catch (e) {
                // UTF-8 è§£ç å¤±è´¥ï¼Œç»§ç»­å°è¯•å…¶ä»–ç¼–ç 
            }

            // 3. å°è¯• GBK ç¼–ç ï¼ˆä¸­æ–‡å¸¸ç”¨ï¼‰
            try {
                const decoder = new TextDecoder('gbk');
                const text = decoder.decode(uint8Array);
                // GBKè§£ç æˆåŠŸ
                return text;
            } catch (e) {
                // GBK ä¹Ÿå¤±è´¥äº†
            }

            // 4. å°è¯• GB2312 ç¼–ç 
            try {
                const decoder = new TextDecoder('gb2312');
                return decoder.decode(uint8Array);
            } catch (e) {
                // GB2312 ä¹Ÿå¤±è´¥äº†
            }

            // 5. æœ€åçš„å¤‡é€‰æ–¹æ¡ˆï¼šå¼ºåˆ¶ UTF-8ï¼ˆå¯èƒ½æœ‰æ›¿æ¢å­—ç¬¦ï¼‰
            const decoder = new TextDecoder('utf-8');
            return decoder.decode(uint8Array);
        }

        // æ˜¾ç¤ºHACKè¯´æ˜å¼¹çª—
        async function showHackInfo() {
            const selectedSystem = document.getElementById('systemFilter').value;
            const modal = document.getElementById('hackModal');
            const title = document.getElementById('hackModalTitle');
            const body = document.getElementById('hackModalBody');

            // æ˜¾ç¤ºå¼¹çª—
            modal.classList.add('show');

            // åŠ è½½å¯¹åº”æ¸¸æˆæœºçš„HACKæ–‡ä»¶
            if (selectedSystem === 'all') {
                title.textContent = 'å…¨éƒ¨æ¸¸æˆæœº HACK è¯´æ˜';
                body.innerHTML = '<div class="no-hack-info">è¯·å…ˆé€‰æ‹©å…·ä½“çš„æ¸¸æˆæœºæŸ¥çœ‹HACKè¯´æ˜</div>';
            } else {
                const systemName = gamesConfig[selectedSystem]?.name || selectedSystem.toUpperCase();
                title.textContent = `${systemName} - HACK è¯´æ˜`;
                body.innerHTML = '<div class="no-hack-info">æ­£åœ¨åŠ è½½...</div>';

                try {
                    // ä»æœåŠ¡å™¨è¯»å– HACK.txt æ–‡ä»¶
                    const response = await fetch(`/roms/${selectedSystem}/HACK.txt`);

                    if (response.ok) {
                        // è¯»å–ä¸º ArrayBuffer ä»¥ä¾¿è‡ªåŠ¨æ£€æµ‹ç¼–ç 
                        const buffer = await response.arrayBuffer();
                        const uint8Array = new Uint8Array(buffer);

                        // æ™ºèƒ½è§£ç å‡½æ•°
                        let content = autoDecodeText(uint8Array);

                        // å°†çº¯æ–‡æœ¬è½¬æ¢ä¸ºHTMLæ ¼å¼ï¼ˆä¿ç•™æ¢è¡Œï¼‰
                        const htmlContent = content
                            .replace(/&/g, '&amp;')
                            .replace(/</g, '&lt;')
                            .replace(/>/g, '&gt;')
                            .replace(/\n/g, '<br>')
                            .replace(/## (.+?)<br>/g, '<h3>$1</h3>')  // æ”¯æŒmarkdownæ ‡é¢˜
                            .replace(/### (.+?)<br>/g, '<h4 style="color: #764ba2; margin-top: 15px;">$1</h4>')  // ä¸‰çº§æ ‡é¢˜
                            .replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>')  // æ”¯æŒåŠ ç²—
                            .replace(/\* /g, 'â€¢ ');  // åˆ—è¡¨ç¬¦å·

                        body.innerHTML = `<div style="white-space: pre-wrap; line-height: 1.8;">${htmlContent}</div>`;
                    } else {
                        body.innerHTML = `<div class="no-hack-info">è¯¥æ¸¸æˆæœºç›®å½•ä¸‹æš‚æ—  HACK.txt æ–‡ä»¶<br><br>è¯·åœ¨ <code>roms/${selectedSystem}/HACK.txt</code> åˆ›å»ºè¯´æ˜æ–‡ä»¶</div>`;
                    }
                } catch (error) {
                    console.error('åŠ è½½HACKæ–‡ä»¶å¤±è´¥:', error);
                    body.innerHTML = `<div class="no-hack-info">åŠ è½½HACKè¯´æ˜å¤±è´¥<br>${error.message}</div>`;
                }
            }
        }

        // å…³é—­HACKè¯´æ˜å¼¹çª—
        function closeHackModal(event) {
            const modal = document.getElementById('hackModal');
            // å¦‚æœç‚¹å‡»çš„æ˜¯èƒŒæ™¯å±‚ï¼Œå…³é—­å¼¹çª—
            if (!event || event.target === modal) {
                modal.classList.remove('show');
            }
        }

        // ESCé”®å…³é—­å¼¹çª—
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                closeHackModal();
            }
        });

        // ä»æœåŠ¡å™¨åŠ è½½æ¸¸æˆåˆ—è¡¨
        // æ‡’åŠ è½½é…ç½®
        let currentOffset = 0;
        let isLoading = false;
        let hasMoreGames = true;
        const BATCH_SIZE = 20; // æ¯æ¬¡åŠ è½½20ä¸ªæ¸¸æˆ

        async function loadGames(reset = false) {
            if (isLoading || (!reset && !hasMoreGames)) return;

            if (reset) {
                currentOffset = 0;
                hasMoreGames = true;
                window.allGamesList = [];
                document.getElementById('gamesGrid').innerHTML = '';
            }

            isLoading = true;

            try {
                // è·å–å½“å‰ç­›é€‰æ¡ä»¶
                const selectedSystem = document.getElementById('systemFilter').value;
                const searchText = document.getElementById('search-input').value.toLowerCase().trim();

                // æ„å»ºè¯·æ±‚URL
                let url = `/api/list-games?offset=${currentOffset}&limit=${BATCH_SIZE}`;
                if (selectedSystem !== 'all') {
                    url += `&system=${selectedSystem}`;
                }

                const response = await fetch(url);
                const data = await response.json();

                const systems = data.games;
                const pagination = data.pagination;

                // è½¬æ¢ä¸ºæ‰å¹³çš„æ¸¸æˆåˆ—è¡¨
                const newGames = [];
                systems.forEach(sys => {
                    sys.games.forEach(game => {
                        newGames.push({
                            system: sys.system,
                            name: game.name,
                            file: game.file,
                            description: game.desc || 'ç»å…¸æ¸¸æˆ'
                        });
                    });
                });

                // åº”ç”¨æœç´¢è¿‡æ»¤ï¼ˆå®¢æˆ·ç«¯ç­›é€‰ï¼‰
                let filteredGames = newGames;
                if (searchText) {
                    filteredGames = newGames.filter(game =>
                        game.name.toLowerCase().includes(searchText)
                    );
                }

                // åˆå¹¶åˆ°å…¨å±€åˆ—è¡¨
                if (!window.allGamesList) window.allGamesList = [];
                window.allGamesList.push(...filteredGames);

                // æ›´æ–°åˆ†é¡µçŠ¶æ€
                currentOffset = pagination.offset + pagination.limit;
                hasMoreGames = pagination.hasMore;

                // è¿½åŠ æ¸²æŸ“æ–°æ¸¸æˆ
                appendGames(filteredGames);

                // å¦‚æœæ²¡æœ‰æ¸¸æˆæ˜¾ç¤ºæç¤º
                if (window.allGamesList.length === 0 && !hasMoreGames) {
                    document.getElementById('gamesGrid').style.display = 'none';
                    document.getElementById('noGames').style.display = 'block';
                } else {
                    document.getElementById('gamesGrid').style.display = 'grid';
                    document.getElementById('noGames').style.display = 'none';
                }

                // æœç´¢æ¨¡å¼ï¼šå¦‚æœæœ‰æœç´¢æ¡ä»¶ä¸”ç»“æœå°‘äº10ä¸ªï¼Œç»§ç»­åŠ è½½
                if (searchText && filteredGames.length < 10 && hasMoreGames) {
                    isLoading = false;
                    await loadGames(false); // é€’å½’åŠ è½½æ›´å¤š
                    return;
                }

            } catch (error) {
                console.error('åŠ è½½æ¸¸æˆåˆ—è¡¨å¤±è´¥:', error);
                if (currentOffset === 0) {
                    document.getElementById('gamesGrid').style.display = 'none';
                    document.getElementById('noGames').style.display = 'block';
                }
            } finally {
                isLoading = false;
            }
        }

        // æ¸²æŸ“æ¸¸æˆåˆ—è¡¨ï¼ˆæ¸…ç©ºå¹¶é‡æ–°æ¸²æŸ“ï¼‰
        function renderGames(games) {
            const grid = document.getElementById('gamesGrid');
            const noGames = document.getElementById('noGames');

            if (games.length === 0) {
                grid.style.display = 'none';
                noGames.style.display = 'block';
                return;
            }

            grid.style.display = 'grid';
            noGames.style.display = 'none';
            grid.innerHTML = '';

            games.forEach(game => {
                const systemInfo = gamesConfig[game.system] || { name: game.system, color: '#666', icon: 'ğŸ®' };
                const card = document.createElement('div');
                card.className = 'game-card';
                card.onclick = () => playGame(game.system, game.file);

                card.innerHTML = `
                    <div class="game-image" style="background: ${systemInfo.color}">
                        <span>${systemInfo.icon}</span>
                    </div>
                    <div class="game-info">
                        <div class="game-title">${game.name}</div>
                        <span class="game-system">${systemInfo.name}</span>
                        <div class="game-desc">${game.description || 'ç»å…¸æ¸¸æˆ'}</div>
                    </div>
                `;

                grid.appendChild(card);
            });
        }

        // è¿½åŠ æ¸¸æˆåˆ°åˆ—è¡¨ï¼ˆç”¨äºæ‡’åŠ è½½ï¼‰
        function appendGames(games) {
            const grid = document.getElementById('gamesGrid');

            games.forEach(game => {
                const systemInfo = gamesConfig[game.system] || { name: game.system, color: '#666', icon: 'ğŸ®' };
                const card = document.createElement('div');
                card.className = 'game-card';
                card.onclick = () => playGame(game.system, game.file);

                card.innerHTML = `
                    <div class="game-image" style="background: ${systemInfo.color}">
                        <span>${systemInfo.icon}</span>
                    </div>
                    <div class="game-info">
                        <div class="game-title">${game.name}</div>
                        <span class="game-system">${systemInfo.name}</span>
                        <div class="game-desc">${game.description || 'ç»å…¸æ¸¸æˆ'}</div>
                    </div>
                `;

                grid.appendChild(card);
            });
        }

        // ç­›é€‰æ¸¸æˆï¼ˆè§¦å‘é‡æ–°åŠ è½½ï¼‰
        function filterGames() {
            // é‡ç½®å¹¶é‡æ–°åŠ è½½æ¸¸æˆåˆ—è¡¨
            loadGames(true);
        }

        // å¯åŠ¨æ¸¸æˆ
        function playGame(system, file) {
            window.location.href = `player.html?system=${system}&rom=${encodeURIComponent(file)}`;
        }

        // é€€å‡ºç™»å½•
        function logout() {
            if (confirm('ç¡®å®šè¦é€€å‡ºç™»å½•å—ï¼Ÿ')) {
                localStorage.removeItem('emulatorjs_user_id');
                localStorage.removeItem('emulatorjs_username');
                window.location.href = 'login.html';
            }
        }

        // æ— é™æ»šåŠ¨æ£€æµ‹
        function setupInfiniteScroll() {
            let scrollTimeout;
            window.addEventListener('scroll', () => {
                // é˜²æŠ–å¤„ç†
                clearTimeout(scrollTimeout);
                scrollTimeout = setTimeout(() => {
                    const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
                    const windowHeight = window.innerHeight;
                    const documentHeight = document.documentElement.scrollHeight;

                    // è·ç¦»åº•éƒ¨200pxæ—¶è§¦å‘åŠ è½½
                    if (scrollTop + windowHeight >= documentHeight - 200) {
                        if (!isLoading && hasMoreGames) {
                            loadGames(false);
                        }
                    }
                }, 100);
            });
        }

        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        window.onload = () => {
            // æ£€æŸ¥ç™»å½•çŠ¶æ€
            const userId = localStorage.getItem('emulatorjs_user_id');
            const username = localStorage.getItem('emulatorjs_username');

            if (!userId || !username) {
                // æœªç™»å½•ï¼Œè·³è½¬åˆ°ç™»å½•é¡µ
                window.location.href = 'login.html';
                return;
            }

            // å·²ç™»å½•ï¼Œæ˜¾ç¤ºç”¨æˆ·åå¹¶åŠ è½½æ¸¸æˆ
            document.querySelector('.subtitle').textContent = `æ¬¢è¿å›æ¥ï¼Œ${username}ï¼åœ¨çº¿æ¸¸ç©ç»å…¸æ¸¸æˆï¼Œå­˜æ¡£è‡ªåŠ¨äº‘ç«¯ä¿å­˜`;

            // åˆå§‹åŒ–æ— é™æ»šåŠ¨
            setupInfiniteScroll();

            // åŠ è½½ç¬¬ä¸€æ‰¹æ¸¸æˆ
            loadGames();
        };
    </script>
</body>
</html>
