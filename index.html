<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EmulatorJS 游戏中心</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Microsoft YaHei', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        header {
            text-align: center;
            color: white;
            margin-bottom: 40px;
        }

        h1 {
            font-size: 3em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .subtitle {
            font-size: 1.2em;
            opacity: 0.9;
        }

        .filter-bar {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 30px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .filter-bar .left {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .filter-bar select {
            padding: 10px 15px;
            border: 2px solid #667eea;
            border-radius: 5px;
            font-size: 16px;
            cursor: pointer;
        }

        #search-input {
            padding: 10px 15px;
            border: 2px solid #667eea;
            border-radius: 5px;
            font-size: 16px;
            width: 250px;
            transition: all 0.3s;
        }

        #search-input:focus {
            outline: none;
            border-color: #5568d3;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        #search-input::placeholder {
            color: #999;
        }

        #logout-btn {
            padding: 10px 20px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s;
            white-space: nowrap;
            flex-shrink: 0;
        }

        #logout-btn:hover {
            background: #5568d3;
        }

        .games-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 25px;
        }

        .game-card {
            background: white;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 10px 20px rgba(0,0,0,0.1);
            transition: transform 0.3s, box-shadow 0.3s;
            cursor: pointer;
        }

        .game-card:hover {
            transform: translateY(-10px);
            box-shadow: 0 15px 30px rgba(0,0,0,0.2);
        }

        .game-image {
            width: 100%;
            height: 180px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 3em;
        }

        .game-info {
            padding: 20px;
        }

        .game-title {
            font-size: 1.2em;
            font-weight: bold;
            color: #333;
            margin-bottom: 10px;
            word-wrap: break-word;
            overflow-wrap: break-word;
            word-break: break-word;
            line-height: 1.4;
        }

        .game-system {
            display: inline-block;
            background: #667eea;
            color: white;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.85em;
            margin-bottom: 10px;
        }

        .game-desc {
            color: #666;
            font-size: 0.9em;
            line-height: 1.4;
        }

        .no-games {
            text-align: center;
            color: white;
            font-size: 1.5em;
            margin-top: 50px;
        }

        /* HACK说明按钮 */
        #hack-info-btn {
            padding: 10px 20px;
            background: #28a745;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s;
            white-space: nowrap;
            margin-left: 10px;
        }

        #hack-info-btn:hover {
            background: #218838;
        }

        /* HACK说明弹窗 */
        .hack-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 10000;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .hack-modal.show {
            display: flex;
        }

        .hack-modal-content {
            background: white;
            border-radius: 15px;
            max-width: 800px;
            max-height: 80vh;
            width: 100%;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }

        .hack-modal-header {
            padding: 20px 25px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .hack-modal-title {
            font-size: 1.5em;
            font-weight: bold;
            margin: 0;
        }

        .hack-modal-close {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            font-size: 2em;
            cursor: pointer;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
        }

        .hack-modal-close:hover {
            background: rgba(255,255,255,0.3);
            transform: rotate(90deg);
        }

        .hack-modal-body {
            padding: 25px;
            overflow-y: auto;
            flex: 1;
        }

        .hack-modal-body h3 {
            color: #667eea;
            margin-top: 20px;
            margin-bottom: 10px;
            padding-bottom: 5px;
            border-bottom: 2px solid #667eea;
        }

        .hack-modal-body p {
            line-height: 1.6;
            color: #555;
            margin: 10px 0;
        }

        .hack-modal-body ul {
            margin: 10px 0;
            padding-left: 25px;
        }

        .hack-modal-body li {
            margin: 8px 0;
            line-height: 1.5;
        }

        .hack-modal-body pre {
            background: #f5f5f5;
            padding: 15px;
            border-radius: 5px;
            overflow-x: auto;
            border-left: 4px solid #667eea;
        }

        .no-hack-info {
            text-align: center;
            color: #999;
            padding: 40px;
            font-size: 1.1em;
        }

        /* 移动端适配 */
        @media (max-width: 768px) {
            body {
                padding: 10px;
            }

            h1 {
                font-size: 2em;
                margin-bottom: 8px;
            }

            .subtitle {
                font-size: 1em;
            }

            header {
                margin-bottom: 25px;
            }

            .filter-bar {
                padding: 15px;
                margin-bottom: 20px;
                flex-direction: column !important;
                align-items: stretch !important;
                gap: 15px;
            }

            .filter-bar .left {
                flex-direction: column;
                align-items: stretch;
                margin-bottom: 0;
                gap: 8px;
            }

            .filter-bar label {
                margin-bottom: 0;
            }

            .filter-bar select {
                padding: 10px 12px;
                font-size: 14px;
                width: 100%;
            }

            #search-input {
                width: 100%;
                padding: 10px 12px;
                font-size: 14px;
            }

            #logout-btn, #hack-info-btn {
                padding: 10px 16px;
                font-size: 14px;
                width: 100%;
                margin-top: 0;
                margin-left: 0;
            }

            #hack-info-btn {
                margin-top: 10px;
            }

            .hack-modal-content {
                max-width: 95vw;
                max-height: 90vh;
            }

            .hack-modal-header {
                padding: 15px 20px;
            }

            .hack-modal-title {
                font-size: 1.2em;
            }

            .hack-modal-body {
                padding: 20px;
            }

            .games-grid {
                grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
                gap: 15px;
            }

            .game-image {
                height: 140px;
                font-size: 2em;
            }

            .game-info {
                padding: 15px;
            }

            .game-title {
                font-size: 1em;
            }

            .game-desc {
                font-size: 0.85em;
            }
        }

        /* 小屏手机适配 */
        @media (max-width: 480px) {
            h1 {
                font-size: 1.8em;
            }

            .subtitle {
                font-size: 0.9em;
            }

            .games-grid {
                grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
                gap: 12px;
            }

            .game-image {
                height: 120px;
                font-size: 1.8em;
            }

            .game-info {
                padding: 12px;
            }

            .game-title {
                font-size: 0.95em;
            }

            .game-system {
                font-size: 0.8em;
                padding: 4px 10px;
            }

            .game-desc {
                font-size: 0.8em;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>🎮 EmulatorJS 游戏中心</h1>
            <p class="subtitle">在线游玩经典游戏，存档自动云端保存</p>
        </header>

        <div class="filter-bar">
            <div class="left">
                <input type="text" id="search-input" placeholder="🔍 搜索游戏名称..." oninput="filterGames()">
                <label>筛选游戏机：</label>
                <select id="systemFilter" onchange="filterGames()">
                    <option value="all">全部游戏机</option>
                    <optgroup label="🎮 任天堂 Nintendo">
                        <option value="nes">任天堂 NES</option>
                        <option value="snes">超级任天堂 SNES</option>
                        <option value="n64">任天堂 64</option>
                        <option value="nds">任天堂 DS</option>
                        <option value="gba">Game Boy Advance</option>
                        <option value="gb">Game Boy</option>
                        <option value="vb">Virtual Boy</option>
                    </optgroup>
                    <optgroup label="🎮 世嘉 Sega">
                        <option value="segaMD">世嘉 MD / Genesis</option>
                        <option value="segaMS">世嘉 Master System</option>
                        <option value="segaGG">世嘉 Game Gear</option>
                        <option value="segaCD">世嘉 CD</option>
                        <option value="sega32x">世嘉 32X</option>
                        <option value="segaSaturn">世嘉 Saturn</option>
                    </optgroup>
                    <optgroup label="🎮 索尼 Sony">
                        <option value="psx">PlayStation</option>
                        <option value="psp">PlayStation Portable</option>
                    </optgroup>
                    <optgroup label="🎮 雅达利 Atari">
                        <option value="atari2600">Atari 2600</option>
                        <option value="atari5200">Atari 5200</option>
                        <option value="atari7800">Atari 7800</option>
                        <option value="lynx">Atari Lynx</option>
                        <option value="jaguar">Atari Jaguar</option>
                    </optgroup>
                    <optgroup label="💻 Commodore">
                        <option value="c64">Commodore 64</option>
                        <option value="c128">Commodore 128</option>
                        <option value="amiga">Commodore Amiga</option>
                        <option value="vic20">Commodore VIC-20</option>
                    </optgroup>
                    <optgroup label="🕹️ 其他 Other">
                        <option value="arcade">街机 Arcade</option>
                        <option value="mame2003">MAME 2003</option>
                        <option value="3do">3DO</option>
                        <option value="coleco">ColecoVision</option>
                    </optgroup>
                </select>
            </div>
            <div style="display: flex; gap: 10px;">
                <button id="hack-info-btn" onclick="showHackInfo()">📝 HACK说明</button>
                <button id="logout-btn" onclick="logout()">退出登录</button>
            </div>
        </div>

        <!-- HACK说明弹窗 -->
        <div class="hack-modal" id="hackModal" onclick="closeHackModal(event)">
            <div class="hack-modal-content" onclick="event.stopPropagation()">
                <div class="hack-modal-header">
                    <h2 class="hack-modal-title" id="hackModalTitle">游戏HACK说明</h2>
                    <button class="hack-modal-close" onclick="closeHackModal()">×</button>
                </div>
                <div class="hack-modal-body" id="hackModalBody">
                    <div class="no-hack-info">正在加载...</div>
                </div>
            </div>
        </div>

        <div class="games-grid" id="gamesGrid">
            <!-- 游戏卡片将由JavaScript动态生成 -->
        </div>

        <div class="no-games" id="noGames" style="display:none;">
            暂无游戏，请先上传ROM文件到服务器
        </div>
    </div>

    <script>
        // 游戏数据配置
        const gamesConfig = {
            nes: {
                name: '任天堂 NES',
                color: '#E60012',
                icon: '🎮',
                games: []
            },
            snes: {
                name: '超级任天堂',
                color: '#8F8F8F',
                icon: '🎯',
                games: []
            },
            gba: {
                name: 'GBA',
                color: '#5E2CA5',
                icon: '🎰',
                games: []
            },
            gb: {
                name: 'Game Boy',
                color: '#9BBC0F',
                icon: '📱',
                games: []
            },
            n64: {
                name: '任天堂64',
                color: '#0066CC',
                icon: '🎲',
                games: []
            },
            psx: {
                name: 'PlayStation',
                color: '#003791',
                icon: '🎪',
                games: []
            }
        };

        // 智能文本解码函数 - 自动检测编码
        function autoDecodeText(uint8Array) {
            // 1. 检查 UTF-8 BOM (EF BB BF)
            if (uint8Array.length >= 3 &&
                uint8Array[0] === 0xEF &&
                uint8Array[1] === 0xBB &&
                uint8Array[2] === 0xBF) {
                // UTF-8 with BOM
                const decoder = new TextDecoder('utf-8');
                return decoder.decode(uint8Array.slice(3));
            }

            // 2. 尝试 UTF-8 解码（严格模式）
            try {
                const decoder = new TextDecoder('utf-8', { fatal: true });
                const text = decoder.decode(uint8Array);
                // 验证解码成功且没有替换字符
                if (text && !text.includes('�')) {
                    return text;
                }
            } catch (e) {
                // UTF-8 解码失败，继续尝试其他编码
            }

            // 3. 尝试 GBK 编码（中文常用）
            try {
                const decoder = new TextDecoder('gbk');
                const text = decoder.decode(uint8Array);
                // GBK解码成功
                return text;
            } catch (e) {
                // GBK 也失败了
            }

            // 4. 尝试 GB2312 编码
            try {
                const decoder = new TextDecoder('gb2312');
                return decoder.decode(uint8Array);
            } catch (e) {
                // GB2312 也失败了
            }

            // 5. 最后的备选方案：强制 UTF-8（可能有替换字符）
            const decoder = new TextDecoder('utf-8');
            return decoder.decode(uint8Array);
        }

        // 显示HACK说明弹窗
        async function showHackInfo() {
            const selectedSystem = document.getElementById('systemFilter').value;
            const modal = document.getElementById('hackModal');
            const title = document.getElementById('hackModalTitle');
            const body = document.getElementById('hackModalBody');

            // 显示弹窗
            modal.classList.add('show');

            // 加载对应游戏机的HACK文件
            if (selectedSystem === 'all') {
                title.textContent = '全部游戏机 HACK 说明';
                body.innerHTML = '<div class="no-hack-info">请先选择具体的游戏机查看HACK说明</div>';
            } else {
                const systemName = gamesConfig[selectedSystem]?.name || selectedSystem.toUpperCase();
                title.textContent = `${systemName} - HACK 说明`;
                body.innerHTML = '<div class="no-hack-info">正在加载...</div>';

                try {
                    // 从服务器读取 HACK.txt 文件
                    const response = await fetch(`/roms/${selectedSystem}/HACK.txt`);

                    if (response.ok) {
                        // 读取为 ArrayBuffer 以便自动检测编码
                        const buffer = await response.arrayBuffer();
                        const uint8Array = new Uint8Array(buffer);

                        // 智能解码函数
                        let content = autoDecodeText(uint8Array);

                        // 将纯文本转换为HTML格式（保留换行）
                        const htmlContent = content
                            .replace(/&/g, '&amp;')
                            .replace(/</g, '&lt;')
                            .replace(/>/g, '&gt;')
                            .replace(/\n/g, '<br>')
                            .replace(/## (.+?)<br>/g, '<h3>$1</h3>')  // 支持markdown标题
                            .replace(/### (.+?)<br>/g, '<h4 style="color: #764ba2; margin-top: 15px;">$1</h4>')  // 三级标题
                            .replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>')  // 支持加粗
                            .replace(/\* /g, '• ');  // 列表符号

                        body.innerHTML = `<div style="white-space: pre-wrap; line-height: 1.8;">${htmlContent}</div>`;
                    } else {
                        body.innerHTML = `<div class="no-hack-info">该游戏机目录下暂无 HACK.txt 文件<br><br>请在 <code>roms/${selectedSystem}/HACK.txt</code> 创建说明文件</div>`;
                    }
                } catch (error) {
                    console.error('加载HACK文件失败:', error);
                    body.innerHTML = `<div class="no-hack-info">加载HACK说明失败<br>${error.message}</div>`;
                }
            }
        }

        // 关闭HACK说明弹窗
        function closeHackModal(event) {
            const modal = document.getElementById('hackModal');
            // 如果点击的是背景层，关闭弹窗
            if (!event || event.target === modal) {
                modal.classList.remove('show');
            }
        }

        // ESC键关闭弹窗
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                closeHackModal();
            }
        });

        // 从服务器加载游戏列表
        // 懒加载配置
        let currentOffset = 0;
        let isLoading = false;
        let hasMoreGames = true;
        const BATCH_SIZE = 20; // 每次加载20个游戏

        async function loadGames(reset = false) {
            if (isLoading || (!reset && !hasMoreGames)) return;

            if (reset) {
                currentOffset = 0;
                hasMoreGames = true;
                window.allGamesList = [];
                document.getElementById('gamesGrid').innerHTML = '';
            }

            isLoading = true;

            try {
                // 获取当前筛选条件
                const selectedSystem = document.getElementById('systemFilter').value;
                const searchText = document.getElementById('search-input').value.toLowerCase().trim();

                // 构建请求URL
                let url = `/api/list-games?offset=${currentOffset}&limit=${BATCH_SIZE}`;
                if (selectedSystem !== 'all') {
                    url += `&system=${selectedSystem}`;
                }

                const response = await fetch(url);
                const data = await response.json();

                const systems = data.games;
                const pagination = data.pagination;

                // 转换为扁平的游戏列表
                const newGames = [];
                systems.forEach(sys => {
                    sys.games.forEach(game => {
                        newGames.push({
                            system: sys.system,
                            name: game.name,
                            file: game.file,
                            description: game.desc || '经典游戏'
                        });
                    });
                });

                // 应用搜索过滤（客户端筛选）
                let filteredGames = newGames;
                if (searchText) {
                    filteredGames = newGames.filter(game =>
                        game.name.toLowerCase().includes(searchText)
                    );
                }

                // 合并到全局列表
                if (!window.allGamesList) window.allGamesList = [];
                window.allGamesList.push(...filteredGames);

                // 更新分页状态
                currentOffset = pagination.offset + pagination.limit;
                hasMoreGames = pagination.hasMore;

                // 追加渲染新游戏
                appendGames(filteredGames);

                // 如果没有游戏显示提示
                if (window.allGamesList.length === 0 && !hasMoreGames) {
                    document.getElementById('gamesGrid').style.display = 'none';
                    document.getElementById('noGames').style.display = 'block';
                } else {
                    document.getElementById('gamesGrid').style.display = 'grid';
                    document.getElementById('noGames').style.display = 'none';
                }

                // 搜索模式：如果有搜索条件且结果少于10个，继续加载
                if (searchText && filteredGames.length < 10 && hasMoreGames) {
                    isLoading = false;
                    await loadGames(false); // 递归加载更多
                    return;
                }

            } catch (error) {
                console.error('加载游戏列表失败:', error);
                if (currentOffset === 0) {
                    document.getElementById('gamesGrid').style.display = 'none';
                    document.getElementById('noGames').style.display = 'block';
                }
            } finally {
                isLoading = false;
            }
        }

        // 渲染游戏列表（清空并重新渲染）
        function renderGames(games) {
            const grid = document.getElementById('gamesGrid');
            const noGames = document.getElementById('noGames');

            if (games.length === 0) {
                grid.style.display = 'none';
                noGames.style.display = 'block';
                return;
            }

            grid.style.display = 'grid';
            noGames.style.display = 'none';
            grid.innerHTML = '';

            games.forEach(game => {
                const systemInfo = gamesConfig[game.system] || { name: game.system, color: '#666', icon: '🎮' };
                const card = document.createElement('div');
                card.className = 'game-card';
                card.onclick = () => playGame(game.system, game.file);

                card.innerHTML = `
                    <div class="game-image" style="background: ${systemInfo.color}">
                        <span>${systemInfo.icon}</span>
                    </div>
                    <div class="game-info">
                        <div class="game-title">${game.name}</div>
                        <span class="game-system">${systemInfo.name}</span>
                        <div class="game-desc">${game.description || '经典游戏'}</div>
                    </div>
                `;

                grid.appendChild(card);
            });
        }

        // 追加游戏到列表（用于懒加载）
        function appendGames(games) {
            const grid = document.getElementById('gamesGrid');

            games.forEach(game => {
                const systemInfo = gamesConfig[game.system] || { name: game.system, color: '#666', icon: '🎮' };
                const card = document.createElement('div');
                card.className = 'game-card';
                card.onclick = () => playGame(game.system, game.file);

                card.innerHTML = `
                    <div class="game-image" style="background: ${systemInfo.color}">
                        <span>${systemInfo.icon}</span>
                    </div>
                    <div class="game-info">
                        <div class="game-title">${game.name}</div>
                        <span class="game-system">${systemInfo.name}</span>
                        <div class="game-desc">${game.description || '经典游戏'}</div>
                    </div>
                `;

                grid.appendChild(card);
            });
        }

        // 筛选游戏（触发重新加载）
        function filterGames() {
            // 重置并重新加载游戏列表
            loadGames(true);
        }

        // 启动游戏
        function playGame(system, file) {
            window.location.href = `player.html?system=${system}&rom=${encodeURIComponent(file)}`;
        }

        // 退出登录
        function logout() {
            if (confirm('确定要退出登录吗？')) {
                localStorage.removeItem('emulatorjs_user_id');
                localStorage.removeItem('emulatorjs_username');
                window.location.href = 'login.html';
            }
        }

        // 无限滚动检测
        function setupInfiniteScroll() {
            let scrollTimeout;
            window.addEventListener('scroll', () => {
                // 防抖处理
                clearTimeout(scrollTimeout);
                scrollTimeout = setTimeout(() => {
                    const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
                    const windowHeight = window.innerHeight;
                    const documentHeight = document.documentElement.scrollHeight;

                    // 距离底部200px时触发加载
                    if (scrollTop + windowHeight >= documentHeight - 200) {
                        if (!isLoading && hasMoreGames) {
                            loadGames(false);
                        }
                    }
                }, 100);
            });
        }

        // 页面加载时初始化
        window.onload = () => {
            // 检查登录状态
            const userId = localStorage.getItem('emulatorjs_user_id');
            const username = localStorage.getItem('emulatorjs_username');

            if (!userId || !username) {
                // 未登录，跳转到登录页
                window.location.href = 'login.html';
                return;
            }

            // 已登录，显示用户名并加载游戏
            document.querySelector('.subtitle').textContent = `欢迎回来，${username}！在线游玩经典游戏，存档自动云端保存`;

            // 初始化无限滚动
            setupInfiniteScroll();

            // 加载第一批游戏
            loadGames();
        };
    </script>
</body>
</html>
